function do_cat12_segment(P)


matlabbatch = make_batch;
inputs = cell(3, 1);

inputs{1,1} = {deblank(P(1,:))}; % Named File Selector: File Set - cfg_files
inputs{2,1} = spm_file(deblank(P(1,:)),'prefix','m'); % Image Calculator: Output Filename - cfg_entry
inputs{3,1} = {spm_file(deblank(P(1,:)),'path')}; % Image Calculator: Output Directory - cfg_files
spm('defaults', 'PET');
cat12('developer')
spm_jobman('run', matlabbatch, inputs{:});


function matlabbatch = make_batch

matlabbatch{1}.cfg_basicio.file_dir.file_ops.cfg_named_file.name = 'R1Volume';
matlabbatch{1}.cfg_basicio.file_dir.file_ops.cfg_named_file.files = {'<UNDEFINED>'};
matlabbatch{2}.spm.spatial.preproc.channel.vols(1) = cfg_dep('Named File Selector: R1Volume(1) - Files', substruct('.','val', '{}',{1}, '.','val', '{}',{1}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','files', '{}',{1}));
matlabbatch{2}.spm.spatial.preproc.channel.biasreg = 0.001;
matlabbatch{2}.spm.spatial.preproc.channel.biasfwhm = 60;
matlabbatch{2}.spm.spatial.preproc.channel.write = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(1).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,1'};
matlabbatch{2}.spm.spatial.preproc.tissue(1).ngaus = 1;
matlabbatch{2}.spm.spatial.preproc.tissue(1).native = [1 0];
matlabbatch{2}.spm.spatial.preproc.tissue(1).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(2).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,2'};
matlabbatch{2}.spm.spatial.preproc.tissue(2).ngaus = 1;
matlabbatch{2}.spm.spatial.preproc.tissue(2).native = [1 0];
matlabbatch{2}.spm.spatial.preproc.tissue(2).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(3).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,3'};
matlabbatch{2}.spm.spatial.preproc.tissue(3).ngaus = 2;
matlabbatch{2}.spm.spatial.preproc.tissue(3).native = [1 0];
matlabbatch{2}.spm.spatial.preproc.tissue(3).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(4).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,4'};
matlabbatch{2}.spm.spatial.preproc.tissue(4).ngaus = 3;
matlabbatch{2}.spm.spatial.preproc.tissue(4).native = [1 0];
matlabbatch{2}.spm.spatial.preproc.tissue(4).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(5).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,5'};
matlabbatch{2}.spm.spatial.preproc.tissue(5).ngaus = 4;
matlabbatch{2}.spm.spatial.preproc.tissue(5).native = [1 0];
matlabbatch{2}.spm.spatial.preproc.tissue(5).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(6).tpm = {'/Users/lund/Dropbox/Applications/spm12_r7771/tpm/TPM.nii,6'};
matlabbatch{2}.spm.spatial.preproc.tissue(6).ngaus = 2;
matlabbatch{2}.spm.spatial.preproc.tissue(6).native = [0 0];
matlabbatch{2}.spm.spatial.preproc.tissue(6).warped = [0 0];
matlabbatch{2}.spm.spatial.preproc.warp.mrf = 1;
matlabbatch{2}.spm.spatial.preproc.warp.cleanup = 1;
matlabbatch{2}.spm.spatial.preproc.warp.reg = [0 0.001 0.5 0.05 0.2];
matlabbatch{2}.spm.spatial.preproc.warp.affreg = 'mni';
matlabbatch{2}.spm.spatial.preproc.warp.fwhm = 0;
matlabbatch{2}.spm.spatial.preproc.warp.samp = 3;
matlabbatch{2}.spm.spatial.preproc.warp.write = [0 0];
matlabbatch{2}.spm.spatial.preproc.warp.vox = NaN;
matlabbatch{2}.spm.spatial.preproc.warp.bb = [NaN NaN NaN
    NaN NaN NaN];
matlabbatch{3}.spm.util.imcalc.input(1) = cfg_dep('Named File Selector: R1Volume(1) - Files', substruct('.','val', '{}',{1}, '.','val', '{}',{1}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','files', '{}',{1}));
matlabbatch{3}.spm.util.imcalc.input(2) = cfg_dep('Segment: c1 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{1}, '.','c', '()',{':'}));
matlabbatch{3}.spm.util.imcalc.input(3) = cfg_dep('Segment: c2 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{2}, '.','c', '()',{':'}));
matlabbatch{3}.spm.util.imcalc.input(4) = cfg_dep('Segment: c3 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{3}, '.','c', '()',{':'}));
matlabbatch{3}.spm.util.imcalc.input(5) = cfg_dep('Segment: c4 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{4}, '.','c', '()',{':'}));
matlabbatch{3}.spm.util.imcalc.input(6) = cfg_dep('Segment: c5 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{5}, '.','c', '()',{':'}));
matlabbatch{3}.spm.util.imcalc.output = '<UNDEFINED>';
matlabbatch{3}.spm.util.imcalc.outdir = '<UNDEFINED>';
matlabbatch{3}.spm.util.imcalc.expression = 'X(1,:).*spm_dilate(spm_dilate(spm_dilate(double(sum(X(2:6,:))>0.2))))';
matlabbatch{3}.spm.util.imcalc.var = struct('name', {}, 'value', {});
matlabbatch{3}.spm.util.imcalc.options.dmtx = 1;
matlabbatch{3}.spm.util.imcalc.options.mask = 0;
matlabbatch{3}.spm.util.imcalc.options.interp = 1;
matlabbatch{3}.spm.util.imcalc.options.dtype = 4;
matlabbatch{4}.spm.tools.cat.estwrite.data(1) = cfg_dep('Image Calculator: ImCalc Computed Image', substruct('.','val', '{}',{3}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','files'));
matlabbatch{4}.spm.tools.cat.estwrite.data_wmh = {''};
matlabbatch{4}.spm.tools.cat.estwrite.nproc = 0;
matlabbatch{4}.spm.tools.cat.estwrite.useprior = '';
matlabbatch{4}.spm.tools.cat.estwrite.opts.tpm = {[spm('DIR') filesep 'tpm' filesep 'TPM.nii']};
matlabbatch{4}.spm.tools.cat.estwrite.opts.affreg = 'mni';
matlabbatch{4}.spm.tools.cat.estwrite.opts.ngaus = [1 1 2 3 4 2];
matlabbatch{4}.spm.tools.cat.estwrite.opts.warpreg = [0 0.001 0.5 0.05 0.2];
matlabbatch{4}.spm.tools.cat.estwrite.opts.bias.biasstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.opts.acc.accstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.opts.redspmres = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.restypes.optimal = [1 0.3];
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.setCOM = 1;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.APP = 1070;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.affmod = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.NCstr = -Inf;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.LASstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.LASmyostr = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.gcutstr = 2;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.cleanupstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.BVCstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.WMHC = 2;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.SLC = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.segmentation.mrf = 1; 
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.T1 =             {[spm('DIR') filesep 'toolbox/cat12/templates_MNI152NLin2009cAsym' filesep 'T1.nii']};{'/Users/lund/Dropbox/Applications/spm12_r7771/toolbox/cat12/templates_MNI152NLin2009cAsym/T1.nii'};
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.brainmask =      {[spm('DIR') filesep 'toolbox/cat12/templates_MNI152NLin2009cAsym' filesep 'brainmask.nii']};{'/Users/lund/Dropbox/Applications/spm12_r7771/toolbox/cat12/templates_MNI152NLin2009cAsym/brainmask.nii'};
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.cat12atlas =     {[spm('DIR') filesep 'toolbox/cat12/templates_MNI152NLin2009cAsym' filesep 'cat.nii']};
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.darteltpm =      {[spm('DIR') filesep 'toolbox/cat12/templates_MNI152NLin2009cAsym' filesep 'Template_1_Dartel.nii']};
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.shootingtpm =    {[spm('DIR') filesep 'toolbox/cat12/templates_MNI152NLin2009cAsym' filesep 'Template_0_GS.nii']};
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.regstr = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.bb = 12;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.registration.vox = 1.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.pbtres = 0.5;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.pbtmethod = 'pbtsimple';
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.SRP = 22;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.reduce_mesh = 1;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.vdist = 2;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.scale_cortex = 0.7;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.add_parahipp = 0.1;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.surface.close_parahipp = 1;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.experimental = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.new_release = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.lazy = 0;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.ignoreErrors = 1;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.verb = 2;
matlabbatch{4}.spm.tools.cat.estwrite.extopts.admin.print = 2;
matlabbatch{4}.spm.tools.cat.estwrite.output.BIDS.BIDSno = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.surface = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.surf_measures = 3;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.neuromorphometrics = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.lpba40 = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.cobra = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.hammers = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.thalamus = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.thalamic_nuclei = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.suit = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.ibsr = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.aal3 = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.mori = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.anatomy3 = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.julichbrain = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.Tian_Subcortex_S4_7T = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.Schaefer2018_100Parcels_17Networks_order = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.Schaefer2018_200Parcels_17Networks_order = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.Schaefer2018_400Parcels_17Networks_order = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.Schaefer2018_600Parcels_17Networks_order = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ROImenu.atlases.ownatlas = {''};
matlabbatch{4}.spm.tools.cat.estwrite.output.GM.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.GM.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.GM.mod = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.GM.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WM.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WM.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WM.mod = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.WM.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.CSF.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.CSF.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.CSF.mod = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.CSF.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ct.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ct.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.ct.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.pp.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.pp.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.pp.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WMH.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WMH.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WMH.mod = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.WMH.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.SL.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.SL.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.SL.mod = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.SL.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.TPMC.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.TPMC.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.TPMC.mod = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.TPMC.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.atlas.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.atlas.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.atlas.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.label.native = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.label.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.label.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.labelnative = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.bias.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.bias.warped = 1;
matlabbatch{4}.spm.tools.cat.estwrite.output.bias.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.las.native = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.las.warped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.las.dartel = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.jacobianwarped = 0;
matlabbatch{4}.spm.tools.cat.estwrite.output.warps = [1 0];
matlabbatch{4}.spm.tools.cat.estwrite.output.rmat = 0;
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(1) = cfg_dep('Segment: Seg Params', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','param', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(2) = cfg_dep('Segment: c1 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{1}, '.','c', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(3) = cfg_dep('Segment: c2 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{2}, '.','c', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(4) = cfg_dep('Segment: c3 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{3}, '.','c', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(5) = cfg_dep('Segment: c4 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{4}, '.','c', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.files(6) = cfg_dep('Segment: c5 Images', substruct('.','val', '{}',{2}, '.','val', '{}',{1}, '.','val', '{}',{1}), substruct('.','tiss', '()',{5}, '.','c', '()',{':'}));
matlabbatch{5}.cfg_basicio.file_dir.file_ops.file_move.action.delete = false;
